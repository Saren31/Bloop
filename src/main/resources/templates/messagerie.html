<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Messagerie Simple</title>
</head>
<body>
<h2>Messagerie simple (test)</h2>

<label>Destinataire ID : <input type="number" id="destId"></label>
<button onclick="chargerHistorique()">Charger</button>

<div id="historique" style="border:1px solid #ccc; height:200px; overflow:auto; margin:10px 0;"></div>

<form onsubmit="envoyer(); return false;">
    <input type="text" id="contenu" placeholder="Votre message..." required>
    <button type="submit">Envoyer</button>
</form>
<button type="button" onclick="envoyerViaWS()">Envoyer via WebSocket</button>

<!-- WebSocket -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let destId = null;

    function chargerHistorique() {
        destId = document.getElementById('destId').value;
        if (!destId) return alert("Saisis un ID destinataire !");
        fetch(`/api/messages/history/${destId}`)
            .then(r => r.json())
            .then(msgs => {
                let h = document.getElementById('historique');
                h.innerHTML = '';
                msgs.forEach(m => {
                    h.innerHTML += `<div><b>${m.expediteur.nomUser || m.expediteur.idUser}:</b> ${m.contenu} <i style="color:grey;font-size:smaller">(${m.dateEnvoi || ""})</i></div>`;
                });
            });
        connecterWebSocket();
    }

    function envoyer() {
        if (!destId) return alert("Charge une conversation d’abord !");
        let contenu = document.getElementById('contenu').value;
        fetch('/api/messages/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `destId=${destId}&contenu=${encodeURIComponent(contenu)}`
        }).then(r => r.json()).then(msg => {
            document.getElementById('contenu').value = '';
            afficherMessage(msg);
        });
    }

    function envoyerViaWS() {
        if (!destId) return alert("Charge une conversation d’abord !");
        let contenu = document.getElementById('contenu').value;
        stompClient.send("/app/chat", {}, JSON.stringify({
            destinataireId: Number(destId),
            contenu: contenu
        }));
        document.getElementById('contenu').value = '';
    }

    function afficherMessage(msg) {
        let h = document.getElementById('historique');
        h.innerHTML += `<div><b>${msg.expediteur.nomUser || msg.expediteur.idUser}:</b> ${msg.contenu} <i style="color:grey;font-size:smaller">(${msg.dateEnvoi || ""})</i></div>`;
        h.scrollTop = h.scrollHeight;
    }

    function connecterWebSocket() {
        if (stompClient) stompClient.disconnect();
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function() {
            stompClient.subscribe("/user/queue/messages", function(message) {
                let msg = JSON.parse(message.body);
                console.log("Message reçu via WebSocket :", msg);
                afficherMessage(msg);
            });
        });
    }
</script>
</body>
</html>
