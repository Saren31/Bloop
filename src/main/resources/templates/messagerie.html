<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Messagerie Simple</title>
</head>
<body>
<h2>Messagerie simple (test)</h2>

<label>Destinataire ID : <input type="number" id="destId"></label>
<button onclick="chargerHistorique()">Charger</button>

<div id="historique" style="border:1px solid #ccc; height:200px; overflow:auto; margin:10px 0;"></div>

<!-- Champ CSRF cach√© (Thymeleaf) -->
<input type="hidden"
       id="csrfToken"
       th:name="${_csrf.parameterName}"
       th:value="${_csrf.token}"
       th:data-header="${_csrf.headerName}" />

<input type="hidden" id="currentUserId" th:value="${currentUserId}" />

<form onsubmit="envoyerViaWS(); return false;">
    <input type="text" id="contenu" placeholder="Votre message..." required>
    <button type="submit">Envoyer via WebSocket</button>
</form>

<!-- WebSocket -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null;
    let destId = null;
    const currentUserId = Number(document.getElementById('currentUserId').value);

    function chargerHistorique() {
        destId = document.getElementById('destId').value;
        if (!destId) return alert("Saisis un ID destinataire !");
        fetch(`/messages/history/${destId}`)
            .then(r => r.json())
            .then(msgs => {
                let h = document.getElementById('historique');
                h.innerHTML = '';
                msgs.forEach(m => {
                    afficherMessage(m); // Utilise la fonction qui g√®re l‚Äôic√¥ne üóëÔ∏è
                });
            });
        connecterWebSocket();
    }

    function getCsrfHeader() {
        // Permet de r√©cup√©rer le header CSRF √† envoyer si jamais tu fais des fetch (ici pour REST, pas WebSocket)
        const csrfInput = document.getElementById('csrfToken');
        return {
            header: csrfInput.getAttribute('data-header') || 'X-CSRF-TOKEN',
            token: csrfInput.value
        };
    }

    function envoyerViaWS() {
        if (!destId) return alert("Charge une conversation d‚Äôabord !");
        let contenu = document.getElementById('contenu').value;
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/chat", {}, JSON.stringify({
                destinataireId: Number(destId),
                contenu: contenu
            }));
            document.getElementById('contenu').value = '';
        } else {
            alert("WebSocket non connect√© !");
        }
    }

    function afficherMessage(msg) {
        let h = document.getElementById('historique');
        let deleteIcon = '';
        if (Number(msg.expediteur.idUser) === currentUserId) {
            deleteIcon = `<span class="delete-msg" data-id="${msg.id}" style="cursor:pointer;color:red;margin-left:8px;">üóëÔ∏è</span>`;
        }
        h.innerHTML += `<div id="msg-${msg.id}">
            <b>${msg.expediteur.nomUser || msg.expediteur.idUser}:</b>
            ${msg.contenu}
            <i style="color:grey;font-size:smaller">(${msg.dateEnvoi || ""})</i>
            ${deleteIcon}
        </div>`;
        h.scrollTop = h.scrollHeight;
        ajouterListenersSuppression();
    }

    function connecterWebSocket() {
        if (stompClient) stompClient.disconnect();
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function() {
            stompClient.subscribe("/user/queue/messages", function(message) {
                let msg = JSON.parse(message.body);
                console.log("Message re√ßu via WebSocket :", msg);
                afficherMessage(msg);
            });
            // Abonnement √† la suppression
            stompClient.subscribe("/user/queue/deleted", function(message) {
                let data = JSON.parse(message.body);
                supprimerMessageDuDOM(data.messageId);
            });
        });
    }

    function ajouterListenersSuppression() {
    document.querySelectorAll('.delete-msg').forEach(el => {
        el.onclick = function() {
            let msgId = this.getAttribute('data-id');
            if (confirm("Supprimer ce message ?")) {
                if (stompClient && stompClient.connected) {
                    stompClient.send("/app/delete", {}, JSON.stringify({ id: Number(msgId) }));
                }
            }
        };
    });
}

function supprimerMessageDuDOM(msgId) {
    let el = document.getElementById('msg-' + msgId);
    if (el) el.remove();
}
</script>
</body>
</html>
